#!/bin/sh

# Copyright 2020 Adevinta

export PG_SSLMODE=${PG_SSLMODE:-prefer}
export SQS_NUMBER_OF_PROCESSORS=${SQS_NUMBER_OF_PROCESSORS:-10}

# Apply env variables
envsubst < config.toml > run.toml

if [ -n "$PG_CA_B64" ]; then
  mkdir /root/.postgresql
  echo $PG_CA_B64 | base64 -d > /root/.postgresql/root.crt   # for flyway
  echo $PG_CA_B64 | base64 -d > /etc/ssl/certs/pg.crt  # for vulcan-api
fi

flyway -user="$PG_USER" -password="$PG_PASSWORD" \
  -url="jdbc:postgresql://$PG_HOST:$PG_PORT/$PG_NAME?sslmode=$PG_SSLMODE" \
  -community -baselineOnMigrate=true -locations=filesystem:/app/sql migrate

exec ./vulnerability-db-consumer -c run.toml
